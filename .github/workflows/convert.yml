name: Rules Converter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write 

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: src
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      
      - name: Setup Mihomo
        run: |
          cd src
          MI_URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.3/mihomo-linux-amd64-v1.19.3.gz"
          curl -sL $MI_URL | gzip -d > mihomo
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/
          mihomo -v  

      - name: Check Updates
        id: check-updates
        run: |
          cd src
          curl -sL "https://github.com/pmkol/easymosdns/raw/rules/cdn_domain_list.txt" -o raw.txt
          
          CURRENT_HASH=$(sha256sum raw.txt | awk '{print $1}')
          echo "Current hash: $CURRENT_HASH"
          
          if [ -f .last_hash ]; then
            LAST_HASH=$(cat .last_hash)
            echo "Last hash: $LAST_HASH"
          else
            LAST_HASH=""
          fi
          
          if [ "$CURRENT_HASH" != "$LAST_HASH" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "$CURRENT_HASH" > .last_hash
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate cdn Rules
        if: steps.check-updates.outputs.update_needed == 'true'
        run: |
          cd src
          # 处理规则文件，移除 "full:" 前缀
          grep -vE '^(#|$)' raw.txt |
          sed 's/^\*\.//g' |  # 移除通配符前缀
          sed 's/^full://g' |  # 移除 "full:" 前缀
          awk '!seen[$0]++' |  # 去重
          sort -f |            # 排序
          awk '{print "DOMAIN-SUFFIX,"$0}' > cdn.list  # 生成规则格式
          
          echo -e "# CDN Domain List\n# Updated: $(date -u +'%Y-%m-%dT%H:%M:%SZ')\n# Total: $(grep -c 'DOMAIN-SUFFIX' cdn.list) rules" | cat - cdn.list > temp && mv temp cdn.list
          
          mihomo convert-ruleset domain text cdn.list cdn.mrs
          
      - name: Generate emby Rules
        run: |
         wget https://raw.githubusercontent.com/KuGouGo/Rules/main/emby.list
         mihomo convert-ruleset domain text emby.list emby.mrs
         
      - name: Commit Changes
        if: steps.check-updates.outputs.update_needed == 'true'
        run: |
          cd src
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add cdn.list cdn.mrs .last_hash
          
          if ! git diff-index --quiet HEAD --; then
            git commit -m "Update: $(date +'%Y-%m-%d')"
            git push origin HEAD:${{ github.ref }}
          fi
