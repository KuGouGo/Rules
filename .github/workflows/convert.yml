name: Rules Converter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: src
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Environment
        run: |
          cd src
          mkdir -p {ipcidr,domain}
          sudo apt-get install -y python3-pip
          pip3 install pyyaml
          curl -sfL "https://github.com/MetaCubeX/mihomo/releases/download/v1.19.3/mihomo-linux-amd64-v1.19.3.gz" | gzip -d > mihomo
          chmod +x mihomo && sudo mv mihomo /usr/local/bin/

      - name: Process Rules
        run: |
          cd src
          
          declare -A RULES=(
            ["domain/cdn"]="https://github.com/pmkol/easymosdns/raw/rules/cdn_domain_list.txt"
            ["domain/ai"]="https://github.com/DustinWin/ruleset_geodata/raw/mihomo-ruleset/ai.list"
            ["domain/cn"]="https://github.com/DustinWin/ruleset_geodata/raw/mihomo-ruleset/cn.list"
            ["domain/fake_ip"]="https://github.com/juewuy/ShellCrash/raw/dev/public/fake_ip_filter.list"
            ["domain/private"]="https://github.com/ForestL18/rules-dat/raw/mihomo/geo/domain/private-domain.list"
            ["domain/paypal"]="https://github.com/MetaCubeX/meta-rules-dat/raw/meta/geo/geosite/paypal.yaml"
            ["ipcidr/privateip"]="https://github.com/ForestL18/rules-dat/raw/mihomo/geo/ipcidr/private-ip.list"
            ["ipcidr/cnip"]="https://github.com/ForestL18/rules-dat/raw/mihomo/asn/combined/China-ASN-combined.list"
            ["ipcidr/telegramip"]="https://github.com/ForestL18/rules-dat/raw/mihomo/asn/combined/Telegram-ASN-combined.list"
            ["ipcidr/googleip"]="https://github.com/ForestL18/rules-dat/raw/mihomo/asn/combined/Google-ASN-combined.list"
          )

          for rule in "${!RULES[@]}"; do
            url="${RULES[$rule]}"
            echo "üîÑ Processing: $rule"

            # ‰∏ãËΩΩ‰∏éÈ¢ÑÂ§ÑÁêÜ
            if ! curl -sfL -o "${rule}.origin" "$url"; then
              echo "::error::Download failed: $url"
              exit 1
            fi

            # YAML Ê†ºÂºèÁâπÊÆäÂ§ÑÁêÜ
            if [[ "$url" == *.yaml ]]; then
              python3 -c "import yaml,sys; print('\n'.join(yaml.safe_load(open('${rule}.origin'))['payload']))" > "${rule}.tmp"
              rm "${rule}.origin"
            else
              mv "${rule}.origin" "${rule}.tmp"
            fi

            # ÂàÜÁ±ªÂ§ÑÁêÜ
            if [[ "$rule" == ipcidr/* ]]; then
              mihomo convert-ruleset ipcidr text "${rule}.tmp" "${rule}.mrs"
            else
              # ÂüüÂêçËßÑÂàôÂ¢ûÂº∫Â§ÑÁêÜ
              sed -i '
                # Âü∫Á°ÄÊ∏ÖÁêÜ
                /^[[:space:]]*$/d;      # Âà†Èô§Á©∫Ë°å
                s/[[:space:]]*$//g;     # Âà†Èô§Ë°åÂ∞æÁ©∫Ê†º

                # ÁßªÈô§Á≠ñÁï•ÂâçÁºÄÔºà‰øùÁïôÈÄöÈÖçÁ¨¶Ôºâ
                s/^full://g;            # ÁßªÈô§ full: ÂâçÁºÄ
                s/^DOMAIN-SUFFIX,//g;   # ÁßªÈô§ DOMAIN-SUFFIX, ÂâçÁºÄ
                s/^DOMAIN,//g;          # ÁßªÈô§ DOMAIN, ÂâçÁºÄ

                # ‰øùÁïôÂéüÂßãÈÄöÈÖçÁ¨¶Ê†ºÂºè
                # ‰∏ç‰øÆÊîπ +.„ÄÅ*. Âíå . ÂâçÁºÄ
                
                # Ê†ºÂºèÈ™åËØÅÔºàÂÖÅËÆ∏‰∏âÁßçÈÄöÈÖçÁ¨¶Ôºâ
                /^(\+\.|\*\.|\.)?[a-zA-Z0-9.-]+$/!d
              ' "${rule}.tmp"

              # ÂéªÈáçÊéíÂ∫èÔºà‰øùÁïôÂéüÂßãÊ†ºÂºèÔºâ
              awk '!seen[tolower($0)]++' "${rule}.tmp" | sort -f > "${rule}.processed"
              mihomo convert-ruleset domain text "${rule}.processed" "${rule}.mrs"
            fi

            # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
            rm -f "${rule}.tmp" "${rule}.processed"
          done

      - name: Commit Changes
        run: |
          cd src
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ipcidr/*.mrs domain/*.mrs
          if ! git diff-index --quiet HEAD; then
            git commit -m "chore: Update rules $(date +'%Y-%m-%d %H:%M')" 
            git push origin HEAD:${{ github.ref }}
          fi
